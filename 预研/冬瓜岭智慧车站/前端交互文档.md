# 前端交互文档

三维场景部署与B端部署在同一服务器上，将占用服务器8088端口，此文档作为前端直接通过iframe嵌入后，通过postmessage进行交互的说明文档；

![image-20200922100046409](C:\Users\AA\AppData\Roaming\Typora\typora-user-images\image-20200922100046409.png)

### 初始化

1. **初始化参数**

   通过iframe链接传入的初始化参数，camera是一个对象，因此传入的时候需要将其序列化处理。

   | 参数名称 | 类型   | 描述                                                         |
   | -------- | ------ | ------------------------------------------------------------ |
   | floor    | string | 显示站内层数：<br />1. 只显示第一层：F1<br />2. 只显示第二层：F2<br />3. 显示全部：不传或者传ALL |
   | bg       | string | 显示背景颜色，默认为：#CCC                                   |
   | camera   | Object | 初始化视角的信息，该信息可以工具中获取当前视角信息：<br />   |
   
    例子：

   ```javascript
const cameraInfo = {
       "x": "",
       "y": "",
       "z": "",
       "fov": "",
       "heading": "",
       "tilt": "",
   };
   
    const url = `http://127.0.0.1:8088/map?floor=F1&bg=#ccc&camera=${encodeURI(JSON.stringify(cameraInfo))}`;
   ```
```
   
2. **初始化交互**

   由于三维场景需要初始化完成后才能调用，因此B端需要在页面初始化发送:

   ```javascript
   {
       "action": "connect",
       "payload": 0,
   }
```

   监听消息，待接收到以下消息后可以进行功能的调用：
   ```javascript
   {
       "action": "connect",
       "payload": 1,
   }
   ```


### 功能

1. **获取当前视角信息**

   ```javascript
   /**
   * @parma {string} payload传"current-camera"调用场景获取当前视角功能
   */
   {
       "action": "tool",
       "payload": "current-camera"
   }
   // 监听信息会返回当前视角信息
   {
       "action": "current-camera",
       "payload": {
           "x": "",
           "y": "",
           "z": "",
           "fov": "",
           "heading": "",
           "tilt": "",
       }  
   }
   
   ```

2. **场景全屏**

   ```js
   /**
   * @parma {string} payload传"fullscreen"调用场景全屏功能
   */
   {
       "action": "tool",
       "payload": "fullscreen"
   }
   ```
   
3. **锁定角度**

   锁定当前视角，仅可在当前视角做移动，拖拽操作返回当前视角信息

   ```javascript
   /**
   * @parma {string} payload传"lock-camera"调用锁定当前视角
   */
   {
       "action": "tool",
       "payload": "lock-camera"
   }
   ```
   
   
   
4. **重置视角**

   ```javascript
   /**
   * @parma {string} payload传"reset-camera"调用重置视角
   */
   {
       "action": "tool",
       "payload": "reset-camera"
   }
   ```

5. **视角移动到指定设备/位置**

   如果传了deviceId,则默认视角移动到该设备所在视角，如果无deviceId，存在其他参数，则视角移动到该参数对应的视角，所有参数可通过获取当前视角信息获取

   ```javascript
   /**
   * @param {string} deviveId 设备id
   * @param {string} x 坐标信息，与deviceId不同时存在
   * @param {string} y 坐标信息，与deviceId不同时存在
   * @param {string} x 坐标信息，与deviceId不同时存在
   * @param {string} fov 坐标信息，与deviceId不同时存在
   * @param {string} heading 坐标信息，与deviceId不同时存在
   * @param {string} tilt 坐标信息，与deviceId不同时存在
   */
   {
       "action": "move",
       "payload": {
           "deviceId": 1,
           "x": "",
           "y": "",
           "z": "",
           "fov": "",
           "heading": "",
           "tilt": "",
       }
   }
   ```

6. **设备分层显示**

      设备分类：PIS、CCTV、PSD、AFC、BAS_1(传感器)、BAS_2（扶梯）、Access（门禁）
       ```javascript
      /**
      * @param {boolean} show true表示显示该图层，false表示关闭图层。
      * @param {Array} layers 表示需要执行的设备图层名称，不传或传空为全部
      */
       {
           "action": "device-layer",
           "payload": {
               "show": true,
               "layers": ['PIS']
           }
       }
       ```

7. **站内巡检

    对应站内巡检功能，目前一共提供三条巡检路线，对应line可传1、2

    ```javascript
    /**
    * @param {number} line 表示巡检路线，可传1、2
    */
    {
        "action": "inspection",
        "payload": {
            "line": 1
        }
    }
    ```

8. **开启热力图**
	开启热力图效果

    ```javascript
    /**
    * @param {string} showHeatMap显示热力图效果
    */
    {
        "action": "showHeatMap",
        "payload": "showHeatMap"
    }
    ```
